<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendSmart - Expenses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { background: var(--bs-body-bg); color: var(--bs-body-color); }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            background-image: 
                linear-gradient(135deg, rgba(40, 116, 240, 0.05) 0%, rgba(255, 153, 0, 0.05) 50%, rgba(229, 50, 56, 0.03) 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><defs><pattern id="navgrid" width="30" height="30" patternUnits="userSpaceOnUse"><path d="M 30 0 L 0 0 0 30" fill="none" stroke="%23e0e0e0" stroke-width="0.5" opacity="0.3"/></pattern></defs><rect width="60" height="60" fill="url(%23navgrid)"/></svg>') !important;
        }
        [data-bs-theme="dark"] .navbar {
            background: rgba(33, 37, 41, 0.95) !important;
            background-image: 
                linear-gradient(135deg, rgba(40, 116, 240, 0.08) 0%, rgba(255, 153, 0, 0.08) 50%, rgba(229, 50, 56, 0.05) 100%),
                url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60"><defs><pattern id="navgrid" width="30" height="30" patternUnits="userSpaceOnUse"><path d="M 30 0 L 0 0 0 30" fill="none" stroke="%23333" stroke-width="0.5" opacity="0.15"/></pattern></defs><rect width="60" height="60" fill="url(%23navgrid)"/></svg>') !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm" data-bs-theme="light">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">SpendSmart</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Price Comparison</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/expenses">Expense Tracker</a>
                    </li>
                    <li class="nav-item ms-2">
                        <button id="theme-toggle" type="button" class="btn btn-outline-secondary btn-sm d-flex align-items-center gap-2">
                            <i id="theme-icon" class="bi bi-lightbulb"></i>
                            <span id="theme-label">Dark mode</span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Add Expense</h5>
                        <form method="POST" action="/expenses">
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" name="date" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" name="category" class="form-control" placeholder="e.g., Groceries, Transport" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" name="amount" class="form-control" min="0" step="0.01" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Payment</label>
                                <select name="payment_method" class="form-select">
                                    <option value="UPI">UPI</option>
                                    <option value="Card">Card</option>
                                    <option value="Cash">Cash</option>
                                    <option value="NetBanking">NetBanking</option>
                                    <option value="Wallet">Wallet</option>
                                    <option value="Other" selected>Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Note</label>
                                <input type="text" name="note" class="form-control" placeholder="Optional" />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Add</button>
                        </form>
                        <div class="mt-4">
                            <div class="text-muted">Total Spent</div>
                            <div class="fs-4 fw-bold">₹{{ '%.2f'|format(total|default(0)) }}</div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Budgets</h5>
                        <form method="POST" action="/budgets" class="row g-2 align-items-end">
                            <div class="col-6">
                                <label class="form-label">Category</label>
                                <input type="text" name="budget_category" class="form-control" placeholder="e.g., Electronics" required />
                            </div>
                            <div class="col-6">
                                <label class="form-label">Monthly Limit (₹)</label>
                                <input type="number" name="budget_limit" class="form-control" min="0" step="0.01" required />
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-outline-primary w-100">Save Budget</button>
                            </div>
                        </form>

                        {% if budgets %}
                        <div class="table-responsive mt-3">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th class="text-end">Limit</th>
                                        <th class="text-end">Spent (this month)</th>
                                        <th class="text-end">Remaining</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for b in budgets %}
                                    <tr>
                                        <td>{{ b.category }}</td>
                                        <td class="text-end">₹{{ '%.2f'|format(b.limit) }}</td>
                                        <td class="text-end">₹{{ '%.2f'|format(b.spent) }}</td>
                                        <td class="text-end {% if b.remaining <= 0 %}text-danger{% endif %}">₹{{ '%.2f'|format(b.remaining) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Expenses</h5>
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Payment</th>
                                        <th class="text-end">Amount (₹)</th>
                                        <th>Note</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for e in expenses %}
                                    <tr>
                                        <td>{{ e['date'] }}</td>
                                        <td>{{ e['category'] }}</td>
                                        <td>{{ e['payment_method'] or 'Other' }}</td>
                                        <td class="text-end">{{ '%.2f'|format(e['amount']) }}</td>
                                        <td>{{ e['note'] }}</td>
                                        <td class="text-end">
                                            <div class="d-inline-flex align-items-center gap-2">
                                                <button type="button" class="btn btn-sm btn-outline-primary"
                                                    data-id="{{ e['id'] }}"
                                                    data-date="{{ e['date'] }}"
                                                    data-category="{{ e['category'] }}"
                                                    data-amount="{{ '%.2f'|format(e['amount']) }}"
                                                    data-note="{{ e['note'] or '' }}"
                                                    data-payment="{{ e['payment_method'] or 'Other' }}"
                                                    onclick="openEditModalFromButton(this)"><i class="bi bi-pencil-square me-1"></i>Edit</button>
                                                <form method="POST" action="/expenses/delete/{{ e['id'] }}" onsubmit="return confirm('Delete this expense?')" class="m-0">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash me-1"></i>Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">By Category</h6>
                                <canvas id="byCategory"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">By Month</h6>
                                <canvas id="byMonth"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Edit Expense Modal -->
    <div class="modal fade" id="editExpenseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="edit-expense-form" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" name="date" id="edit-date" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" name="category" id="edit-category" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount (₹)</label>
                            <input type="number" name="amount" id="edit-amount" class="form-control" step="0.01" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment</label>
                            <select name="payment_method" id="edit-payment" class="form-select">
                                <option value="UPI">UPI</option>
                                <option value="Card">Card</option>
                                <option value="Cash">Cash</option>
                                <option value="NetBanking">NetBanking</option>
                                <option value="Wallet">Wallet</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Note</label>
                            <input type="text" name="note" id="edit-note" class="form-control" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        async function loadCharts() {
            try {
                const res = await fetch('/api/expenses/summary');
                const data = await res.json();
                const catLabels = data.byCategory.map(x => x.category);
                const catValues = data.byCategory.map(x => x.total);
                new Chart(document.getElementById('byCategory'), {
                    type: 'pie',
                    data: { labels: catLabels, datasets: [{ data: catValues, backgroundColor: ['#2874f0','#ff9900','#e53238','#28a745','#6f42c1','#fd7e14','#20c997'] }] },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });
                const monthLabels = data.byMonth.map(x => x.month);
                const monthValues = data.byMonth.map(x => x.total);
                new Chart(document.getElementById('byMonth'), {
                    type: 'line',
                    data: { labels: monthLabels, datasets: [{ label: '₹ Spent', data: monthValues, borderColor: '#2874f0', tension: 0.3 }] },
                    options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            } catch (e) {
                console.error('Failed to load charts', e);
            }
        }
        loadCharts();

        (function() {
            const key = 'ss-theme';
            const root = document.documentElement;
            function applyTheme(t) {
                root.setAttribute('data-bs-theme', t);
                const label = document.getElementById('theme-label');
                const icon = document.getElementById('theme-icon');
                if (label) label.textContent = t === 'dark' ? 'Light mode' : 'Dark mode';
                if (icon) {
                    icon.classList.remove('bi-lightbulb','bi-lightbulb-fill');
                    icon.classList.add(t === 'dark' ? 'bi-lightbulb-fill' : 'bi-lightbulb');
                }
            }
            let theme = localStorage.getItem(key) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(theme);
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.addEventListener('click', function() {
                    theme = theme === 'dark' ? 'light' : 'dark';
                    localStorage.setItem(key, theme);
                    applyTheme(theme);
                });
            }
        })();

        function openEditModal(exp) {
            document.getElementById('edit-date').value = exp.date || '';
            document.getElementById('edit-category').value = exp.category || 'Other';
            document.getElementById('edit-amount').value = exp.amount || 0;
            document.getElementById('edit-note').value = exp.note || '';
            document.getElementById('edit-payment').value = exp.payment || 'Other';
            const form = document.getElementById('edit-expense-form');
            form.action = `/expenses/edit/${exp.id}`;
            const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
            modal.show();
        }
        function openEditModalFromButton(btn) {
            const exp = {
                id: btn.getAttribute('data-id'),
                date: btn.getAttribute('data-date'),
                category: btn.getAttribute('data-category'),
                amount: btn.getAttribute('data-amount'),
                note: btn.getAttribute('data-note'),
                payment: btn.getAttribute('data-payment')
            };
            openEditModal(exp);
        }
    </script>
</body>
</html>
